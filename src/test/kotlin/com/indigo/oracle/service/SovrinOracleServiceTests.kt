package com.indigo.oracle.service

import com.beust.klaxon.*
import net.corda.testing.CHARLIE_KEY
import net.corda.testing.TestDependencyInjectionBase
import net.corda.testing.node.MockServices
import org.hyperledger.indy.sdk.anoncreds.Anoncreds
import org.junit.Test
import kotlin.test.assertEquals
import kotlin.test.assertNotNull
import kotlin.test.assertTrue

class SovrinOracleServiceTests : TestDependencyInjectionBase() {
    private val dummyServices = MockServices(listOf("com.indigo.contract"), CHARLIE_KEY)
    private val oracle = Oracle(dummyServices)

    val issuerDid = "W4SGRU86Z58d6TV7PBUe6g" //part of agent code, DID of trust anchor
    val schema = "{\"seqNo\":1,\"data\": {\"name\":\"gvt\",\"version\":\"1.0\",\"keys\":[\"age\",\"sex\",\"height\",\"name\"]}}"
    val masterSecret = "mastersecret" //protection against replay attacks, "really big number", determined by client and stored by client
    val claimOffer = "{\"issuer_did\":\"$issuerDid\", \"schema_seq_no\":1}"
    val claimOfferFilter = "{\"issuer_did\":\"$issuerDid\"}"
    val claimDef = "{\"ref\":1,\"origin\":\"W4SGRU86Z58d6TV7PBUe6g\",\"signature_type\":\"CL\",\"data\":{\"primary\":{\"n\":\"99136395550777881964722073162954953931118213678144955814947712094579489985960125242311469899382326077241702510269626225686771185088844516809165314002900864711311763871323332720803711667237679956882844343498879815882875907211027852937335248181737276556819319366960008563921700147162671301372595466985588642323380151060057647887276185361672914050763544722267897466174528798988724254943244358948463365523263322626645570220451121342960211376591114781978008551715476507775841891869930026974827170635710723982832037550286697300868991573549367196294533029493422134407244633084338938177351455833731582927478459583897392940553\",\"s\":\"9499293644958544980320154463929934655967632253477712647106626244216038791210013263125699912013118379849984771483484844441677345736128721880729760353434045247067573042405587256509822858822185389932965194518298487130886975911161898175643282752017022756782449342577057509084053012770030051652097588505105551965321281835654913975294253391165417460195910786242941002038960789354119699301384272520003140117199622946572060055890287446269639906128430613430742783429053128433838769862244777055507049647657045058205070102266782503423780715439115055580912503287660949306779915169570345724087708208064018971266935728454208704374\",\"rms\":\"29209915395502154013638636903077218422782664741184201437764289139449942170795894534423041543612821626826517452987455092666197208185019327290206025567251717182709214824794049426406868700874245055812310542101620302639853714804129862464723299844735975215582698241892083895096569954273071475720399996297463131008520565133164276082165551474405225576478628596839038958286691887509006017637296936994476039380816352616267279985542996457508929054306508042642767523643844859367141864940784605679505186319279692806712659278159282225033407205014078296873962125907480739047776586812233026092353514378215529618858477326951496180121\",\"r\":{\"name\":\"96855205251254862714520690533794516852856649642186407200557087345676839308938773896037616443095864541382300366028627339589452273446381424670130112887930172106622027049313705382150522686158763205971874494453121993391856406964744789125351450611043326488340184382999665113348225702143860805019105198608193287131239825035883767721279217672315461161173667125713077046279776867006360199790209561114320702447951183067441565395769559907548407366003747511600442497465231320461832806329434404884473322014514045745322703904268938748495444485468379293668672371905216006276613260233498140313127343788290379797322355827857254498695\",\"age\":\"4333059349810279728059313741454455820834952320850676479234035967518710548248108974886587176335663966440814265487254655482411974754710458197821131798620600588853651085039206121568967677726439363553087865732836377482466362954685080401128982287064099119045264567884833983884746271545158703280174750326879872423554756267755523985049849695232055183239811346987544877222023423994969123727091699890238772943424207920730842891312189859590180772406778028919684360026488349848865037225951823761812804417635101467694719864080300769508307107591624998630903687576118557813382255428378760960454424790632629520987169473607064540366\",\"sex\":\"84746235456266859019606432695004232781651196743730957986835626862514401582962942147074239608876257752495531604395398435264409797698838011991408453263643157980015602916835196755525234446866173854817223088006425334889615286789166410035758651539765233092748812450293510098304108575317499406717533651710090956615008684254678097228291335845743757213071515996559298351969964300524310137052715182688061004812585054981607530783195400526986902079240649725318596792096375249396383845054569384384397960928605985950971083667629075338279851198704423140416818091142742275885223150017339567631659868329550562575391606682670992825293\",\"height\":\"37489274988404844932461751595166098441402036550116394768060259009873908802406420652055928613746197433929684454454054429676851758906853188841951623609383233222965313020750821425012940441332523727735483389177055145739464726342738562033785628839467567063424624772415798013192148697620525054811977880649285214087008641905961695183052646782704693512685483024972959607894574913139015414458532915289709070820018700918963234407077042507274388987127027830815824004556523825982705761791940565111105092213064754272780426079845797630786524054471011672724173985297261229643670995499171810461082119259481262152324812477208974052559\"},\"rctxt\":\"75527652440146117575825650936384235305043346249881003750698838636034790743215790858955528858131299062519429629778661307736089271909520254740923001277142141079163241147804393977219858653261871437121685558691433539197101103739586058522909082925679486229924653865817892020273895095862940532751249563522548237610078180694870944103872647418397720919770480800577404651177916889804951205666658311669702498247362870940659648574582064634597425325164917854282153192259598749448079527858085027192506642976666900547254118105957170005196041826608465481263892596934698123163763319006887297873701574664974778731103566209716019542015\",\"z\":\"79477726345281032764912659121059822507893106301918289770825783353571809685626270313613618990121332568118722748800111871557620048092062786220871651717642696013138390227238802062669306838465756066832447397751054063043343005352296616169703075245589187674595521634889611099725945621780838488445898670390144022963655396891031085944985409456849379712025770647580731565890470834623032153351393493507402512182903853559012803674921561042348385221465890807162201955806940323975762210915844141555542006109623994220518820760180240957841744814922378386640592422110363468577545682068941499863607205293579487734407425617716573907017\"},\"revocation\":null}}"
    var claimRequest = "{\"blinded_ms\":{\"prover_did\":\"V4SGRU86Z58d6TV7PBUe6f\",\"u\":\"63233337739020429041197106928016037089362724386884433568661205452231774184699791220266251233061953934978086792477622287158823954857020990692198950728776576290716544215974025358982752336998576964135966573417163625299637258982065173444854944853358567181155757208458050943905217166902819191323054931035721113083844709247393785487837753377306851322383432151640803549406366078627780791008861660637583144605432344636295498742125427798666005685631893103147176469295274670309655039682292391153808691381590511263567933888560023993946965300897931585330866321882027841082647878246430793804712618757103373351048803647184520440886\",\"ur\":null},\"issuer_did\":\"W4SGRU86Z58d6TV7PBUe6g\",\"schema_seq_no\":1}\n"
    val claimAttributes = "{\"sex\":[\"male\",\"5944657099558967239210949258394887428692050081607692519917050011144233115103\"],\"name\":[\"Alex\",\"1139481716457488690172217916278103335\"],\"height\":[\"175\",\"175\"],\"age\":[\"28\",\"28\"]}"
    var issuerClaim = "{\"claim\":{\"sex\":[\"male\",\"5944657099558967239210949258394887428692050081607692519917050011144233115103\"],\"height\":[\"175\",\"175\"],\"name\":[\"Alex\",\"1139481716457488690172217916278103335\"],\"age\":[\"28\",\"28\"]},\"schema_seq_no\":1,\"signature\":{\"primary_claim\":{\"m2\":\"81132576343873584117115247812406629061708008411196750753399815804807474640192\",\"a\":\"76766967059267199422443550404042043956684861734360629958784741485835174791064979486032091863629055683427301710945908303881725457188353573452656794304686038157603746102154108742908057874283645588508792985158130056548779143425128041754292405279510959382936383224810370186294255406484823079293059381564363064015218716988718347813916712809892385873281347928403155620860936026389301844590624843711033853174683780780548921430320012052731379724082069432804523065816688144753589856818655471825315046345232293429750029223650009627252519494683125358183781711931585253333157757446214370047330870172632430743968858182384340437339\",\"e\":\"259344723055062059907025491480697571938277889515152306249728583105665800713306759149981690559193987143012367913206299323899696942213235956742930007022235535980125468466167182342897\",\"v\":\"6406689518849501583373118124304688814368938830966449538778242252202356942260886954866147536654069371078812050233913549538480458366975176429456243407801149594750408319153182380654090383599343250433522220418720632132656067539593931452423078207911527050748340094881098041908653455427963435315073747450295843590307051968704388093488304069544146404025813871864089369941608971416520342243974610205324581023903257396311888317157921375418365741171578189698402387264085338002845866002933793390607189112820747915596830819998251707996363371651185934372570197081682246713694299153247409540160551650281722630990410380302059831832070362854206610960616617168442608550283839478027302839933777673246983226136957727414290079511303633599485326389721545366749508061770509747651711601179525424128604863713994324938294351331286969665816730637\"},\"non_revocation_claim\":null},\"issuer_did\":\"W4SGRU86Z58d6TV7PBUe6g\"}\n"
    val proofRequest = "{\"nonce\":\"123432421212\",\"name\":\"proof_req_1\",\"version\":\"0.1\",\"requested_attrs\":{\"attr1_uuid\":{\"schema_seq_no\":1,\"name\":\"name\"},\"attr2_uuid\":{\"schema_seq_no\":1,\"name\":\"sex\"}},\"requested_predicates\":{\"predicate1_uuid\":{\"attr_name\":\"age\",\"p_type\":\"GE\",\"value\":18}}}"
    val selfAttestedValue = "yes"
    var claimUuid = "claim::091f0580-06e0-4f2c-96c2-73480ac9caa8"
    val revocRegs = "{}"

    @Test
    fun `generate a did`() {
        val did = oracle.generateDID()
        println("did: $did")
        assertNotNull(did, "Generated DID was null")
    }

    @Test
    fun `create a data schema`() {
        val newClaimDef = oracle.createClaimDef(schema)
        println("new data schema: $newClaimDef")
        assertNotNull(newClaimDef, "Built claim definition was null")
    }

    @Test
    fun `establish a prover master secret`() {
        oracle.establishMasterSecret(masterSecret)
        //TODO: how to test Unit response?
    }

    @Test
    fun `store claim offer`() {
        oracle.storeClaimOffer(claimOffer)
        //TODO: how to test Unit response?
    }

    @Test
    fun `get a data schema`() {
        val schema = oracle.getClaimOffers(claimOfferFilter)
        println("retrieved data schema: $schema")
        assertNotNull(schema, "Retrieved claim definition was null")
        //TODO: test for non empty result
    }

    @Test
    fun `create claim request`() {
        claimRequest = oracle.createClaimRequest(claimOffer, claimDef, masterSecret)
        println("claim request: $claimRequest")
        assertNotNull(claimRequest, "Retrieved claim request was null")
    }

    @Test
    fun `issuer create claim`() {
        issuerClaim = oracle.issuerCreateClaim(claimRequest, claimAttributes)
        println("issuer claim: $issuerClaim")
        assertNotNull(issuerClaim, "Retrieved issuers claim request was null")
    }

    @Test
    fun `prover store claim`() {
        oracle.proverStoreClaim(issuerClaim)
        //TODO: test for non empty result
    }

    @Test
    fun `claims for proof request`() {
        val claimsForProof = oracle.claimsForProofReq(proofRequest)
        println("proof request: $claimsForProof")
        assertNotNull(claimsForProof, "Claims for proof request was null")
        val claimsForAttribute1 = claimsForProof.obj("attrs")?.array<JsonObject>("attr1_uuid")
        val claimsForAttribute2 = claimsForProof.obj("attrs")?.array<JsonObject>("attr1_uuid")
        val claimsForPredicate = claimsForProof.obj("predicates")?.array<JsonObject>("predicate1_uuid")

        assertTrue(claimsForAttribute1?.size ?: 0 > 0)
        assertTrue(claimsForAttribute2?.size ?: 0 > 0)
        assertTrue(claimsForPredicate?.size ?: 0 > 0)

        assertNotNull(claimsForAttribute1?.first()?.get("claim_uuid").toString())

    }

    @Test
    fun `prover create proof`() {
        val requestedClaims = "{\"self_attested_attributes\":{\"self1\":\"$selfAttestedValue\"},\"requested_attrs\":{\"attr1_uuid\":[\"$claimUuid\", true],\"attr2_uuid\":[\"$claimUuid\", false]},\"requested_predicates\":{\"predicate1_uuid\":\"$claimUuid\"}}"
        val schemas = "{\"$claimUuid\":$schema}"
        val claimDefs = "{\"$claimUuid\":$claimDef}"

        var proof = oracle.proverCreateProof(proofRequest, requestedClaims, schemas, masterSecret, claimDefs, revocRegs)
        println("proof: $proof")
        assertNotNull(proof, "Proof was null")
        //TODO: more json checks
        assertEquals("Alex",
                proof.obj("requested_proof")?.obj("revealed_attrs")?.array<String>("attr1_uuid")?.get(1))

        assertNotNull(proof.obj("requested_proof")?.obj("unrevealed_attrs")?.get("attr2_uuid"))

        assertEquals(selfAttestedValue, proof.obj("requested_proof")?.obj("self_attested_attrs")?.get("self1"))

        val valid = Anoncreds.verifierVerifyProof(proofRequest, proof.toJsonString(), schemas, claimDefs, revocRegs).get()
        assertTrue(valid)
    }


}